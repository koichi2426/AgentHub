# AGENTHUB/worker/Dockerfile

# å®‰å®šç‰ˆã®Pythonã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
FROM python:3.10-slim

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
WORKDIR /app

# ----------------------------------------------------
# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ----------------------------------------------------
# worker/requirements.txt ã‚’ã‚³ãƒ”ãƒ¼
COPY requirements.txt .

# å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir -r requirements.txt

# ----------------------------------------------------
# ğŸš¨ GGUF å¤‰æ›ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (llama.cppã«ç½®ãæ›ãˆ)
# ----------------------------------------------------
# C/C++ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¨gitã€ãŠã‚ˆã³CURLã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        cmake \
        build-essential \
        libcurl4-openssl-dev && \
    rm -rf /var/lib/apt/lists/*

# 1. llama.cpp ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€å¼ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã® /app/llama.cpp ã«ã‚¯ãƒ­ãƒ¼ãƒ³
RUN git clone https://github.com/ggerganov/llama.cpp.git /app/llama.cpp

# 2. llama.cpp ã® Python ä¾å­˜é–¢ä¿‚ (GGUFå¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir -r /app/llama.cpp/requirements.txt

# 3. llama.cpp ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ« (quantizeãªã©) ã‚’ç”¨æ„
#    cmake -B build: buildãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
#    cmake --build build: å®Ÿéš›ã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
#    -- -j$(nproc): ã‚³ã‚¢æ•°ã«å¿œã˜ãŸä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ (é«˜é€ŸåŒ–)
RUN cd /app/llama.cpp && cmake -B build && cmake --build build -- -j$(nproc)

# 4. train_and_export.py ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
#    HuggingFace â†’ GGUF F16 å¤‰æ›ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ENV GGUF_CONVERT_SCRIPT=/app/llama.cpp/convert_hf_to_gguf.py

#    GGUF F16 â†’ GGUF Q4_0 é‡å­åŒ–ç”¨ãƒã‚¤ãƒŠãƒª
ENV GGUF_QUANTIZE_SCRIPT=/app/llama.cpp/build/bin/quantize
# ----------------------------------------------------
# ç½®ãæ›ãˆå®Œäº†
# ----------------------------------------------------


# ----------------------------------------------------
# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
# ----------------------------------------------------
# worker ãƒ•ã‚©ãƒ«ãƒ€å…¨ä½“ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
# ã“ã‚Œã«ã¯ celery_app.py, repository/, tasks/ ãªã©å…¨ã¦ãŒå«ã¾ã‚Œã¾ã™
COPY . /app/worker/

# ----------------------------------------------------
# 3. èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
# ----------------------------------------------------
# Celeryã¯ docker-compose.yml ã® command ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å®šç¾©ã—ã¾ã›ã‚“ã€‚
# CMD ["celery", "-A", "worker.celery_app", "worker", "-l", "info"]
