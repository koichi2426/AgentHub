# AGENTHUB/worker/Dockerfile

# å®‰å®šç‰ˆã®Pythonã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
FROM python:3.10-slim

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
WORKDIR /app

# ----------------------------------------------------
# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ----------------------------------------------------
# worker/requirements.txt ã‚’ã‚³ãƒ”ãƒ¼
COPY requirements.txt .

# å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Celery, Redis, SQLAlchemy, DBã‚³ãƒã‚¯ã‚¿ãªã©)
RUN pip install --no-cache-dir -r requirements.txt

# ----------------------------------------------------
# ğŸš¨ GGUF å¤‰æ›ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã“ã“ã‹ã‚‰è¿½åŠ )
# ----------------------------------------------------
# 1. git ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ (debianç³»OSã®å ´åˆ)
RUN apt-get update && apt-get install -y --no-install-recommends git && \
    rm -rf /var/lib/apt/lists/*

# 2. bert.cpp ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€å¼ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã® /app/bert.cpp ã«ã‚¯ãƒ­ãƒ¼ãƒ³
RUN git clone https://github.com/skeskinen/bert.cpp.git /app/bert.cpp

# 3. bert.cpp ã® convert ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦ã¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
#    (ãƒ¡ã‚¤ãƒ³ã® requirements.txt ã¨é‡è¤‡ã—ã¦ã„ã¦ã‚‚ã€å¿µã®ãŸã‚å®Ÿè¡Œ)
RUN pip install --no-cache-dir -r /app/bert.cpp/requirements.txt

# 4. train_and_export.py ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
ENV GGUF_CONVERT_SCRIPT=/app/bert.cpp/models/convert-to-ggml.py
# ----------------------------------------------------
# ğŸš¨ è¿½åŠ ã“ã“ã¾ã§
# ----------------------------------------------------


# ----------------------------------------------------
# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
# ----------------------------------------------------
# worker ãƒ•ã‚©ãƒ«ãƒ€å…¨ä½“ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
# ã“ã‚Œã«ã¯ celery_app.py, repository/, tasks/ ãªã©å…¨ã¦ãŒå«ã¾ã‚Œã¾ã™
COPY . /app/worker/

# ----------------------------------------------------
# 3. èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ (CMD ã¯ docker-compose.yml ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯çœç•¥å¯èƒ½ã§ã™ãŒã€
#    ã“ã“ã§ã¯ Celery ã®å®Ÿè¡Œç’°å¢ƒã‚’æƒ³å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™)
# ----------------------------------------------------
# Celeryã¯ docker-compose.yml ã® command ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å®šç¾©ã—ã¾ã›ã‚“ã€‚
# CMD ["celery", "-A", "worker.celery_app", "worker", "-l", "info"]